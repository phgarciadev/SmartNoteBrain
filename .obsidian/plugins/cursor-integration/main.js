var J=Object.create;var R=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var z=Object.getPrototypeOf,G=Object.prototype.hasOwnProperty;var K=(a,e)=>{for(var t in e)R(a,t,{get:e[t],enumerable:!0})},F=(a,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of j(e))!G.call(a,i)&&i!==t&&R(a,i,{get:()=>e[i],enumerable:!(n=V(e,i))||n.enumerable});return a};var C=(a,e,t)=>(t=a!=null?J(z(a)):{},F(e||!a||!a.__esModule?R(t,"default",{value:a,enumerable:!0}):t,a)),Y=a=>F(R({},"__esModule",{value:!0}),a);var re={};K(re,{default:()=>x});module.exports=Y(re);var c=require("obsidian");var B=require("http"),W=require("crypto");var h=require("obsidian");var p=C(require("fs")),$=C(require("os")),N=C(require("path")),w=N.join($.tmpdir(),"obsidian-cursor.log"),Q=5*1024*1024,I=class{constructor(e){this.source=e}formatMessage(e,t){return`[${new Date().toISOString().replace("T"," ").replace("Z","")}] [${this.source}] [${e}] ${t}
`}write(e,t){let n=this.formatMessage(e,t);try{if(p.existsSync(w)&&p.statSync(w).size>Q){let s=p.readFileSync(w,"utf8").split(`
`),l=s.slice(Math.floor(s.length/2));p.writeFileSync(w,l.join(`
`))}p.appendFileSync(w,n)}catch(i){}}debug(e){this.write("DEBUG",e)}info(e){this.write("INFO",e)}warn(e){this.write("WARN",e)}error(e){this.write("ERROR",e)}},o=new I("OBS");async function A(a,e,t){let n=document.createElement("div");n.addClass("markdown-preview-view","markdown-rendered","obsidian-render-offscreen"),document.body.appendChild(n);let i=new h.Component;i.load();let r=a.vault.getAbstractFileByPath(e),s=r instanceof h.TFile?r.path:"";await h.MarkdownRenderer.render(a,t,n,s,i);let l=n.innerHTML;return{container:n,html:l}}var T=null,O=0,Z=3e5;function L(){let a=Date.now();if(T!==null&&a-O<Z)return T;o.debug("Extracting CSS (cache miss or expired)");let e=[];for(let t=0;t<document.styleSheets.length;t++){let n=document.styleSheets[t];try{if(n.cssRules)for(let i=0;i<n.cssRules.length;i++)e.push(n.cssRules[i].cssText)}catch(i){}}return T=e.join(`
`),O=a,o.debug(`CSS extracted: ${T.length} bytes, ${e.length} rules`),T}function k(a,e,t){var d;let n=e.indexOf("|"),i=n>=0?e.substring(0,n):e,r=n>=0?e.substring(n+1):e,s=a.vault.getAbstractFileByPath(t),l=a.metadataCache.getFirstLinkpathDest(i,s instanceof h.TFile?s.path:""),u=(d=l==null?void 0:l.path)!=null?d:"";return{displayText:r,targetPath:u}}var f=null,P,U,q;try{f=(q=(U=(P=require("electron").remote)==null?void 0:P.getCurrentWindow)==null?void 0:U.call(P))!=null?q:null}catch(a){f=null}var M=class{constructor(e,t,n){this.server=null;this.clients=new Set;this.onRestartRequest=null;this.currentFilePath=null;this.currentSocket=null;this.currentMonitor=null;this.pendingRender=null;this.isProcessing=!1;this.lastSentHtml="";this.monitorSessionId=0;this.app=e,this.settings=t,this.onRestartRequest=n!=null?n:null}async start(){this.server=(0,B.createServer)(),this.server.on("upgrade",(e,t)=>{let n=e.headers["sec-websocket-key"];if(!n){t.destroy();return}let r=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${(0,W.createHash)("sha1").update(n+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11").digest("base64")}`,"",""].join(`\r
`);t.write(r),this.clients.add(t),t.on("data",s=>{let l=this.decodeFrame(s);l&&this.handleMessage(l,t)}),t.on("close",()=>{this.clients.delete(t),this.currentSocket===t&&this.stopMonitoring()}),t.on("error",()=>{this.clients.delete(t)})}),this.server.listen(this.settings.port)}stop(){var e;this.stopMonitoring();for(let t of this.clients)t.destroy();this.clients.clear(),(e=this.server)==null||e.close(),this.server=null}ensureWindowVisible(){if(f)try{f.isMinimized()&&(o.debug("[WINDOW] Restoring minimized window to prevent throttling"),f.restore()),f.setSize(200,200),f.setPosition(0,0)}catch(e){o.debug(`[WINDOW] Failed to control window: ${e}`)}}stopMonitoring(){this.currentMonitor&&(this.currentMonitor.observer.disconnect(),clearTimeout(this.currentMonitor.timer),this.currentMonitor.debounceTimer&&clearTimeout(this.currentMonitor.debounceTimer),document.body.removeChild(this.currentMonitor.container),this.currentMonitor=null),this.currentFilePath=null,this.currentSocket=null,this.lastSentHtml=""}decodeFrame(e){if(e.length<2)return null;let t=e[1],n=(t&128)!==0,i=t&127,r=2;i===126?(i=e.readUInt16BE(2),r=4):i===127&&(i=e.readUInt32BE(6),r=10);let s=null;n&&(s=e.subarray(r,r+4),r+=4);let l=e.subarray(r,r+i);if(s)for(let u=0;u<l.length;u++)l[u]^=s[u%4];return l.toString("utf8")}sendFrame(e,t){let n=Buffer.from(t,"utf8"),i=n.length,r;i<126?(r=Buffer.alloc(2),r[0]=129,r[1]=i):i<65536?(r=Buffer.alloc(4),r[0]=129,r[1]=126,r.writeUInt16BE(i,2)):(r=Buffer.alloc(10),r[0]=129,r[1]=127,r.writeBigUInt64BE(BigInt(i),2)),e.write(Buffer.concat([r,n]))}async handleMessage(e,t){let n;try{n=JSON.parse(e)}catch(i){o.error("Invalid JSON received"),this.sendFrame(t,JSON.stringify({type:"error",message:"Invalid JSON"}));return}if(n.type==="render"){await this.handleRenderRequest(n,t);return}if(n.type==="resolve"){let i=k(this.app,n.link,n.currentFile);this.sendFrame(t,JSON.stringify({type:"resolve",displayText:i.displayText,targetPath:i.targetPath}));return}if(n.type==="getSettings"){o.debug("Settings request received"),this.sendFrame(t,JSON.stringify({type:"settings",renderTimeout:this.settings.renderTimeout,typingDelay:this.settings.typingDelay,updateDelay:this.settings.updateDelay,monitorTime:this.settings.monitorTime,protocolVersion:2}));return}if(n.type==="restart"){o.info("Restart request received - reloading plugin"),this.onRestartRequest?this.onRestartRequest():(this.stop(),this.start());return}if(n.type==="getImgurConfig"){o.debug("Imgur config request received");let i=await this.getImgurConfig();this.sendFrame(t,JSON.stringify(i));return}o.warn(`Unknown request type: ${e}`),this.sendFrame(t,JSON.stringify({type:"error",message:"Unknown request type"}))}async handleRenderRequest(e,t){let n=e.filePath.split(/[/\\]/).pop()||e.filePath;if(this.currentFilePath!==e.filePath&&this.currentMonitor&&(o.debug(`[SWITCH] ${n} (stopping previous monitor)`),this.stopMonitoring()),this.isProcessing){o.debug(`[QUEUE] ${n}`),this.pendingRender={request:e,socket:t};return}await this.executeRender(e,t)}async executeRender(e,t){let n=e.filePath.split(/[/\\]/).pop()||e.filePath,i=e.content.length,r=Date.now();this.ensureWindowVisible(),this.isProcessing=!0,this.currentFilePath=e.filePath,this.currentSocket=t,o.info(`[START] ${n} (${i} chars)`);try{let{container:s,html:l}=await A(this.app,e.filePath,e.content),u=Date.now()-r,d=L();o.info(`[DONE] ${n} in ${u}ms (${l.length} bytes)`),this.lastSentHtml=l,this.sendFrame(t,JSON.stringify({type:"render",html:l,css:d,filePath:e.filePath,isUpdate:!1})),this.startMonitoring(s,e.filePath,t,d)}catch(s){let l=Date.now()-r,u=String(s);o.error(`[FAIL] ${n} after ${l}ms: ${u}`),this.sendFrame(t,JSON.stringify({type:"error",message:u})),this.stopMonitoring()}finally{if(this.isProcessing=!1,this.pendingRender){let s=this.pendingRender;this.pendingRender=null,s.request.filePath===this.currentFilePath&&this.stopMonitoring();let l=s.request.filePath.split(/[/\\]/).pop()||s.request.filePath;o.debug(`[DEQUEUE] ${l}`),await this.executeRender(s.request,s.socket)}}}startMonitoring(e,t,n,i){let r=t.split(/[/\\]/).pop()||t,s=this.settings.updateDelay*1e3,l=this.settings.monitorTime*1e3,u=++this.monitorSessionId,d=()=>{if(!this.currentMonitor||this.currentMonitor.sessionId!==u)return;let g=e.innerHTML;g!==this.lastSentHtml&&(o.debug(`[UPDATE] ${r} (${g.length} bytes)`),this.lastSentHtml=g,this.sendFrame(n,JSON.stringify({type:"render",html:g,css:i,filePath:t,isUpdate:!0})))},y=new MutationObserver(()=>{!this.currentMonitor||this.currentMonitor.sessionId!==u||(this.currentMonitor.debounceTimer&&clearTimeout(this.currentMonitor.debounceTimer),this.currentMonitor.debounceTimer=setTimeout(d,s))});y.observe(e,{childList:!0,subtree:!0,attributes:!0,characterData:!0});let S=setTimeout(()=>{!this.currentMonitor||this.currentMonitor.sessionId!==u||(o.debug(`[MONITOR END] ${r}`),d(),y.disconnect(),this.currentMonitor.debounceTimer&&clearTimeout(this.currentMonitor.debounceTimer),document.body.removeChild(e),this.currentMonitor=null)},l);this.currentMonitor={observer:y,timer:S,debounceTimer:null,container:e,sessionId:u},o.debug(`[MONITOR START] ${r} #${u} (${this.settings.monitorTime}s)`)}async getImgurConfig(){var t,n,i,r;let e="obsidian-imgur-plugin";try{let s=this.app.plugins;if(!((t=s==null?void 0:s.plugins)==null?void 0:t[e]))return o.debug("Imgur plugin not found"),{type:"imgurConfig",available:!1};let d=`${this.app.vault.adapter.basePath}/.obsidian/plugins/${e}/data.json`,y=require("fs"),S,g;if(y.existsSync(d)){let D=y.readFileSync(d,"utf-8"),v=JSON.parse(D);S=v.clientId,g=v.uploadStrategy}let m;try{if(m=(n=localStorage.getItem("imgur-access-token"))!=null?n:void 0,m||(m=(i=localStorage.getItem(`${e}-access-token`))!=null?i:void 0),!m)for(let v=0;v<localStorage.length;v++){let b=localStorage.key(v);if(b&&b.toLowerCase().includes("imgur")&&b.toLowerCase().includes("token")&&(m=(r=localStorage.getItem(b))!=null?r:void 0,m)){o.debug(`Found access token under key: ${b}`);break}}}catch(D){o.debug("Could not access localStorage for access token")}return o.info(`Imgur config: strategy=${g!=null?g:"unknown"}, hasClientId=${!!S}, hasAccessToken=${!!m}`),{type:"imgurConfig",available:!0,clientId:S,accessToken:m,uploadStrategy:g}}catch(s){return o.error(`Failed to get imgur config: ${s instanceof Error?s.message:String(s)}`),{type:"imgurConfig",available:!1}}}};var _=require("child_process"),X=27123,ee=30,te=.3,ne=.2,ie=5,H={port:X,renderTimeout:ee,typingDelay:te,updateDelay:ne,monitorTime:ie},x=class extends c.Plugin{constructor(){super(...arguments);this.server=null;this.settings=H}async onload(){o.info("Plugin loading..."),await this.loadSettings(),this.addSettingTab(new E(this.app,this)),this.server=new M(this.app,this.settings,()=>{this.reloadPlugin()}),await this.server.start(),o.info(`Server started on port ${this.settings.port}`),new c.Notice(`Render server started on port ${this.settings.port}`),this.addCommand({id:"restart-render-server",name:"Restart render server",callback:()=>{this.reloadPlugin()}}),this.addCommand({id:"open-vault-in-cursor",name:"Open vault in Cursor",callback:()=>{this.openInCursor()}})}onunload(){var t;(t=this.server)==null||t.stop(),this.server=null}async loadSettings(){let t=await this.loadData();this.settings=Object.assign({},H,t!=null?t:{})}async saveSettings(){await this.saveData(this.settings)}reloadPlugin(){let t=this.manifest.id;o.info(`Reloading plugin: ${t}`);let n=this.app;n.plugins.disablePlugin(t).then(()=>n.plugins.enablePlugin(t)).then(()=>{o.info("Plugin reloaded successfully")}).catch(i=>{o.error(`Failed to reload plugin: ${i.message}`)})}openInCursor(){let t=this.app.vault.adapter.basePath;if(!t){new c.Notice("Could not determine vault path");return}(0,_.exec)(`cursor "${t}"`,n=>{n?(new c.Notice(`Cursor command not found. Please install Cursor CLI:
Open Cursor \u2192 Cmd/Ctrl+Shift+P \u2192 'Install cursor command'`),o.warn("Cursor command failed, CLI not installed")):(new c.Notice("Opening vault in Cursor..."),o.info(`Opened vault in Cursor: ${t}`))})}},E=class extends c.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),new c.Setting(e).setName("Server port").setDesc("Port for the render server (requires plugin restart)").addText(t=>t.setPlaceholder("27123").setValue(String(this.plugin.settings.port)).onChange(async n=>{let i=parseInt(n,10);!isNaN(i)&&i>0&&i<65536&&(this.plugin.settings.port=i,await this.plugin.saveSettings())})),new c.Setting(e).setName("Render timeout").setDesc("Maximum time (seconds) to wait for render() to return").addText(t=>t.setPlaceholder("30").setValue(String(this.plugin.settings.renderTimeout)).onChange(async n=>{let i=parseFloat(n);!isNaN(i)&&i>0&&(this.plugin.settings.renderTimeout=i,await this.plugin.saveSettings())})),new c.Setting(e).setName("Typing delay").setDesc("Wait this long (seconds) after user stops typing before sending render request").addText(t=>t.setPlaceholder("0.3").setValue(String(this.plugin.settings.typingDelay)).onChange(async n=>{let i=parseFloat(n);!isNaN(i)&&i>=0&&(this.plugin.settings.typingDelay=i,await this.plugin.saveSettings())})),new c.Setting(e).setName("Update delay").setDesc("After DOM changes, wait this long (seconds) with no new changes before sending update").addText(t=>t.setPlaceholder("0.2").setValue(String(this.plugin.settings.updateDelay)).onChange(async n=>{let i=parseFloat(n);!isNaN(i)&&i>=0&&(this.plugin.settings.updateDelay=i,await this.plugin.saveSettings())})),new c.Setting(e).setName("Monitor time").setDesc("How long (seconds) to monitor DOM for changes after render completes").addText(t=>t.setPlaceholder("5").setValue(String(this.plugin.settings.monitorTime)).onChange(async n=>{let i=parseFloat(n);!isNaN(i)&&i>=0&&(this.plugin.settings.monitorTime=i,await this.plugin.saveSettings())}))}};
